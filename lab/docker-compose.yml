version: '3.8'

services:
  orchestrator:
    build:
      context: ..
      dockerfile: lab/Dockerfile.c2
    container_name: hydra-c2-lab
    tty: true
    stdin_open: true
    networks:
      hydra_net:
        ipv4_address: 10.5.0.5
    cap_add:
      - NET_RAW
      - NET_ADMIN
    ports:
      - "8080:8080"
      - "53:53/udp"
      - "123:123/udp"
    restart: on-failure

  # AGENT 1: ALPHA
  target-alpha:
    build:
      context: ..
      dockerfile: lab/Dockerfile.agent
    container_name: hydra-agent-alpha
    networks:
      hydra_net:
        ipv4_address: 10.5.0.10
    cap_add:
      - NET_RAW
      - NET_ADMIN
    environment:
      - AGENT_ID=HYDRA-ALPHA
      - AWS_ACCESS_KEY_ID=AKIA_HYDRA_TEST_DATA
    depends_on:
      - orchestrator

  # AGENT 2: BRAVO (For Mesh Testing)
  target-bravo:
    build:
      context: ..
      dockerfile: lab/Dockerfile.agent
    container_name: hydra-agent-bravo
    networks:
      hydra_net:
        ipv4_address: 10.5.0.11
    cap_add:
      - NET_RAW
      - NET_ADMIN
    environment:
      - AGENT_ID=HYDRA-BRAVO
      - AZURE_CLIENT_ID=AZURE_HYDRA_TEST_DATA
    depends_on:
      - orchestrator

  # TARGET 3: CHARLIE (Clean machine for Phase 4 Infection)
  target-charlie:
    image: alpine:latest
    container_name: hydra-target-clean
    command: tail -f /dev/null
    networks:
      hydra_net:
        ipv4_address: 10.5.0.12

networks:
  hydra_net:
    driver: bridge
    ipam:
      config:
        - subnet: 10.5.0.0/24